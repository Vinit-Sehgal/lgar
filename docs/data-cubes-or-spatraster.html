<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 5 Data-cubes or SpatRaster | Data Visualization and Geospatial Analysis With R</title>
  <meta name="description" content="Chapter 5 Data-cubes or SpatRaster | Data Visualization and Geospatial Analysis With R" />
  <meta name="generator" content="bookdown 0.37 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 5 Data-cubes or SpatRaster | Data Visualization and Geospatial Analysis With R" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 5 Data-cubes or SpatRaster | Data Visualization and Geospatial Analysis With R" />
  
  
  

<meta name="author" content="Vinit Sehgal (Louisiana State University), Debasish Mishra (Texas A&amp;M University) &amp; Frank Anyoka Adekilae (Louisiana State University)" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="geospatial-operations-on-rastervector-data.html"/>
<link rel="next" href="parallel-computation-for-geospatial-analysis.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.2.1/leaflet.js"></script>
<script src="libs/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.2.1/leaflet-providers-plugin.js"></script>
<script src="libs/brick(sm)_937a64-1/data_stars_bricksm2ab351.txt"></script>
<script src="libs/joda-0.0.1/joda.js"></script>
<script src="libs/joda-0.0.1/addImageQuery-bindings.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/HomeButton-0.0.1/home-button.css" rel="stylesheet" />
<script src="libs/HomeButton-0.0.1/home-button.js"></script>
<script src="libs/HomeButton-0.0.1/easy-button-src.min.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Large-scale Geospatial Analysis in R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="import-libraries-and-sample-dataset.html"><a href="import-libraries-and-sample-dataset.html"><i class="fa fa-check"></i><b>2</b> Import libraries and sample dataset</a></li>
<li class="chapter" data-level="3" data-path="raster-and-shapefile-visualization.html"><a href="raster-and-shapefile-visualization.html"><i class="fa fa-check"></i><b>3</b> Raster and shapefile visualization</a>
<ul>
<li class="chapter" data-level="3.1" data-path="raster-and-shapefile-visualization.html"><a href="raster-and-shapefile-visualization.html#plotting-raster-data"><i class="fa fa-check"></i><b>3.1</b> Plotting raster data</a></li>
<li class="chapter" data-level="3.2" data-path="raster-and-shapefile-visualization.html"><a href="raster-and-shapefile-visualization.html#customizing-terra-plot-options"><i class="fa fa-check"></i><b>3.2</b> Customizing <code>terra</code> plot options</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="raster-and-shapefile-visualization.html"><a href="raster-and-shapefile-visualization.html#scientific-color-palettes"><i class="fa fa-check"></i><b>3.2.1</b> Scientific Color palettes</a></li>
<li class="chapter" data-level="3.2.2" data-path="raster-and-shapefile-visualization.html"><a href="raster-and-shapefile-visualization.html#customize-terra-plots"><i class="fa fa-check"></i><b>3.2.2</b> Customize <code>terra</code> plots</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="raster-and-shapefile-visualization.html"><a href="raster-and-shapefile-visualization.html#plotting-raster-data-using-tidyterra"><i class="fa fa-check"></i><b>3.3</b> Plotting raster data using <code>tidyterra</code></a></li>
<li class="chapter" data-level="3.4" data-path="raster-and-shapefile-visualization.html"><a href="raster-and-shapefile-visualization.html#plotting-vector-data"><i class="fa fa-check"></i><b>3.4</b> Plotting vector data</a></li>
<li class="chapter" data-level="3.5" data-path="raster-and-shapefile-visualization.html"><a href="raster-and-shapefile-visualization.html#reprojection-of-rasters-using-terraproject"><i class="fa fa-check"></i><b>3.5</b> Reprojection of rasters using <code>terra::project</code></a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="geospatial-operations-on-rastervector-data.html"><a href="geospatial-operations-on-rastervector-data.html"><i class="fa fa-check"></i><b>4</b> Geospatial operations on raster/vector data</a>
<ul>
<li class="chapter" data-level="4.1" data-path="geospatial-operations-on-rastervector-data.html"><a href="geospatial-operations-on-rastervector-data.html#raster-resampling"><i class="fa fa-check"></i><b>4.1</b> Raster resampling</a></li>
<li class="chapter" data-level="4.2" data-path="geospatial-operations-on-rastervector-data.html"><a href="geospatial-operations-on-rastervector-data.html#raster-summary-statistics"><i class="fa fa-check"></i><b>4.2</b> Raster summary statistics</a></li>
<li class="chapter" data-level="4.3" data-path="geospatial-operations-on-rastervector-data.html"><a href="geospatial-operations-on-rastervector-data.html#summarizing-rasters-using-shapefles"><i class="fa fa-check"></i><b>4.3</b> Summarizing rasters using shapefles</a></li>
<li class="chapter" data-level="4.4" data-path="geospatial-operations-on-rastervector-data.html"><a href="geospatial-operations-on-rastervector-data.html#diy-summarize-raster-using-classified-raster"><i class="fa fa-check"></i><b>4.4</b> DIY: Summarize raster using classified raster</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="data-cubes-or-spatraster.html"><a href="data-cubes-or-spatraster.html"><i class="fa fa-check"></i><b>5</b> Data-cubes or SpatRaster</a>
<ul>
<li class="chapter" data-level="5.1" data-path="data-cubes-or-spatraster.html"><a href="data-cubes-or-spatraster.html#create-subset-and-visualize-spatraster"><i class="fa fa-check"></i><b>5.1</b> Create, subset and visualize SpatRaster</a></li>
<li class="chapter" data-level="5.2" data-path="data-cubes-or-spatraster.html"><a href="data-cubes-or-spatraster.html#geospatial-operations-on-spatraster"><i class="fa fa-check"></i><b>5.2</b> Geospatial operations on SpatRaster</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="data-cubes-or-spatraster.html"><a href="data-cubes-or-spatraster.html#time-series-extraction-from-spatraster"><i class="fa fa-check"></i><b>5.2.1</b> Time-series extraction from SpatRaster</a></li>
<li class="chapter" data-level="5.2.2" data-path="data-cubes-or-spatraster.html"><a href="data-cubes-or-spatraster.html#spatial-extractionsummary-from-spatraster"><i class="fa fa-check"></i><b>5.2.2</b> Spatial extraction/summary from SpatRaster</a></li>
<li class="chapter" data-level="5.2.3" data-path="data-cubes-or-spatraster.html"><a href="data-cubes-or-spatraster.html#crop-and-mask-spatraster"><i class="fa fa-check"></i><b>5.2.3</b> Crop and mask SpatRaster</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="data-cubes-or-spatraster.html"><a href="data-cubes-or-spatraster.html#layer-wise-operations-on-spatraster"><i class="fa fa-check"></i><b>5.3</b> Layer-wise operations on SpatRaster</a></li>
<li class="chapter" data-level="5.4" data-path="data-cubes-or-spatraster.html"><a href="data-cubes-or-spatraster.html#cell-wise-operations-with-app-lapp-tapp"><i class="fa fa-check"></i><b>5.4</b> Cell-wise operations with <code>app</code>, <code>lapp</code>, <code>tapp</code></a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="data-cubes-or-spatraster.html"><a href="data-cubes-or-spatraster.html#app-cell-wise-operation-on-all-layers"><i class="fa fa-check"></i><b>5.4.1</b> app: Cell-wise operation on all layers</a></li>
<li class="chapter" data-level="5.4.2" data-path="data-cubes-or-spatraster.html"><a href="data-cubes-or-spatraster.html#tapp-cell-wise-operation-on-layer-groups"><i class="fa fa-check"></i><b>5.4.2</b> tapp: Cell-wise operation on layer groups</a></li>
<li class="chapter" data-level="5.4.3" data-path="data-cubes-or-spatraster.html"><a href="data-cubes-or-spatraster.html#lapp-layers-as-function-arguments"><i class="fa fa-check"></i><b>5.4.3</b> lapp: layers as function arguments</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="parallel-computation-for-geospatial-analysis.html"><a href="parallel-computation-for-geospatial-analysis.html"><i class="fa fa-check"></i><b>6</b> Parallel computation for geospatial analysis</a>
<ul>
<li class="chapter" data-level="6.1" data-path="parallel-computation-for-geospatial-analysis.html"><a href="parallel-computation-for-geospatial-analysis.html#cellwise-implimentation-of-functions"><i class="fa fa-check"></i><b>6.1</b> Cellwise implimentation of functions</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="parallel-computation-for-geospatial-analysis.html"><a href="parallel-computation-for-geospatial-analysis.html#apply-custom-function-to-pixel-time-series"><i class="fa fa-check"></i><b>6.1.1</b> Apply custom function to pixel time series</a></li>
<li class="chapter" data-level="6.1.2" data-path="parallel-computation-for-geospatial-analysis.html"><a href="parallel-computation-for-geospatial-analysis.html#best-practices-for-large-scale-operations"><i class="fa fa-check"></i><b>6.1.2</b> Best practices for large-scale operations</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="parallel-computation-for-geospatial-analysis.html"><a href="parallel-computation-for-geospatial-analysis.html#layerwise-implimentation-of-functions"><i class="fa fa-check"></i><b>6.2</b> Layerwise implimentation of functions</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="parallel-computation-for-geospatial-analysis.html"><a href="parallel-computation-for-geospatial-analysis.html#data-cubes-as-lists"><i class="fa fa-check"></i><b>6.2.1</b> Data cubes as lists</a></li>
<li class="chapter" data-level="6.2.2" data-path="parallel-computation-for-geospatial-analysis.html"><a href="parallel-computation-for-geospatial-analysis.html#blockwise-summary-of-feature-extracted-data"><i class="fa fa-check"></i><b>6.2.2</b> Blockwise summary of feature extracted data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="supplementary-material.html"><a href="supplementary-material.html"><i class="fa fa-check"></i><b>7</b> Supplementary material</a>
<ul>
<li class="chapter" data-level="7.1" data-path="supplementary-material.html"><a href="supplementary-material.html#exporting-spatraster-to-netcdf-data"><i class="fa fa-check"></i><b>7.1</b> Exporting SpatRaster to NetCDF Data</a></li>
<li class="chapter" data-level="7.2" data-path="supplementary-material.html"><a href="supplementary-material.html#updating-r-using-rstudio"><i class="fa fa-check"></i><b>7.2</b> Updating R using RStudio</a></li>
<li class="chapter" data-level="7.3" data-path="supplementary-material.html"><a href="supplementary-material.html#changing-temp-files-for-large-storage"><i class="fa fa-check"></i><b>7.3</b> Changing Temp files for large storage</a></li>
<li class="chapter" data-level="7.4" data-path="supplementary-material.html"><a href="supplementary-material.html#resampling-with-rgdalwarp"><i class="fa fa-check"></i><b>7.4</b> Resampling with rgdalwarp</a></li>
</ul></li>
<li class="divider"></li>
<li><a href=https://soil-hydrology.com/" target="blank">https://soil-hydrology.com/</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Data Visualization and Geospatial Analysis With R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="data-cubes-or-spatraster" class="section level1 hasAnchor" number="5">
<h1><span class="header-section-number">Chapter 5</span> Data-cubes or SpatRaster<a href="data-cubes-or-spatraster.html#data-cubes-or-spatraster" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<hr />
<p><strong>Whats is a <code>Spatraster</code>?</strong></p>
A SpatRaster represents multi-layer (multi-variable) raster data. It always stores a number of fundamental parameters describing its geometry. These include the number of columns and rows, the spatial extent, and the Coordinate Reference System.
<br>
<center>
<img src="SampleData-master/images/stack2022.png" style="width:90.0%" />
</center>
<p><br></p>
<p>In addition, a SpatRaster can store information about the file in which the raster cell values are stored (equivalent to <code>Raster Stack</code>). Or, if there is no such file, a SpatRaster can hold the cell values in memory (equivalent to <code>Raster Brick</code> from the older <code>raster</code> package).</p>
<p>Note: Raster operations on cell values stored in memory are usually faster but computationally intensive.</p>
<div id="create-subset-and-visualize-spatraster" class="section level2 hasAnchor" number="5.1">
<h2><span class="header-section-number">5.1</span> Create, subset and visualize SpatRaster<a href="data-cubes-or-spatraster.html#create-subset-and-visualize-spatraster" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We will create multilayer SpatRaster for <code>NDVI</code> and <code>SMAP SM</code> from the sample dataset and demonstrate several applications and operations. Working with SpatRaster is very similar to working with regular arrays or lists.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="data-cubes-or-spatraster.html#cb59-1" tabindex="-1"></a><span class="do">###############################################################</span></span>
<span id="cb59-2"><a href="data-cubes-or-spatraster.html#cb59-2" tabindex="-1"></a><span class="co">#~~~ Create and plot NDVI SpatRaster</span></span>
<span id="cb59-3"><a href="data-cubes-or-spatraster.html#cb59-3" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb59-4"><a href="data-cubes-or-spatraster.html#cb59-4" tabindex="-1"></a></span>
<span id="cb59-5"><a href="data-cubes-or-spatraster.html#cb59-5" tabindex="-1"></a><span class="co"># Location of the NDVI raster files</span></span>
<span id="cb59-6"><a href="data-cubes-or-spatraster.html#cb59-6" tabindex="-1"></a>ndvi_path<span class="ot">=</span><span class="st">&quot;./SampleData-master/raster_files/NDVI/&quot;</span> <span class="co">#Specify location of NDVI rasters</span></span>
<span id="cb59-7"><a href="data-cubes-or-spatraster.html#cb59-7" tabindex="-1"></a></span>
<span id="cb59-8"><a href="data-cubes-or-spatraster.html#cb59-8" tabindex="-1"></a><span class="co"># List of all NDVI rasters</span></span>
<span id="cb59-9"><a href="data-cubes-or-spatraster.html#cb59-9" tabindex="-1"></a>ras_path<span class="ot">=</span><span class="fu">list.files</span>(ndvi_path,<span class="at">pattern=</span><span class="st">&#39;*.tif&#39;</span>,<span class="at">full.names=</span><span class="cn">TRUE</span>)</span>
<span id="cb59-10"><a href="data-cubes-or-spatraster.html#cb59-10" tabindex="-1"></a><span class="fu">head</span>(ras_path)</span></code></pre></div>
<pre><code>## [1] &quot;./SampleData-master/raster_files/NDVI/NDVI_resamp_2016-01-01.tif&quot;
## [2] &quot;./SampleData-master/raster_files/NDVI/NDVI_resamp_2016-01-17.tif&quot;
## [3] &quot;./SampleData-master/raster_files/NDVI/NDVI_resamp_2016-02-02.tif&quot;
## [4] &quot;./SampleData-master/raster_files/NDVI/NDVI_resamp_2016-02-18.tif&quot;
## [5] &quot;./SampleData-master/raster_files/NDVI/NDVI_resamp_2016-03-05.tif&quot;
## [6] &quot;./SampleData-master/raster_files/NDVI/NDVI_resamp_2016-03-21.tif&quot;</code></pre>
<p>Let’s import NDVI rasters from the location and store as a 3D data cube. We will use <code>lapply</code>, <code>map</code>, and <code>for</code> loop using <code>addlayer</code> function to import rasters from paths stored <code>ras_list</code>. We will also learn how to add shapefiles to the background of all plots made using RasterBrick/Stack.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="data-cubes-or-spatraster.html#cb61-1" tabindex="-1"></a><span class="co"># Method 1: Use lapply to create raster layer list from the raster location</span></span>
<span id="cb61-2"><a href="data-cubes-or-spatraster.html#cb61-2" tabindex="-1"></a>ras_list <span class="ot">=</span> <span class="fu">lapply</span>(<span class="fu">paste</span>(ras_path, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>), rast)</span>
<span id="cb61-3"><a href="data-cubes-or-spatraster.html#cb61-3" tabindex="-1"></a><span class="co">#This a list of 23 raster objects stored as individual elements.</span></span>
<span id="cb61-4"><a href="data-cubes-or-spatraster.html#cb61-4" tabindex="-1"></a></span>
<span id="cb61-5"><a href="data-cubes-or-spatraster.html#cb61-5" tabindex="-1"></a><span class="co">#Convert raster layer lists to data cube/Spatraster </span></span>
<span id="cb61-6"><a href="data-cubes-or-spatraster.html#cb61-6" tabindex="-1"></a>ras_stack <span class="ot">=</span> <span class="fu">rast</span>(ras_list)     <span class="co"># Stacking all rasters as a data cube!!! </span></span>
<span id="cb61-7"><a href="data-cubes-or-spatraster.html#cb61-7" tabindex="-1"></a><span class="co"># This a multi-layer (23 layers in this case) SpatRaster Object.</span></span>
<span id="cb61-8"><a href="data-cubes-or-spatraster.html#cb61-8" tabindex="-1"></a></span>
<span id="cb61-9"><a href="data-cubes-or-spatraster.html#cb61-9" tabindex="-1"></a><span class="co">#inMemory() reports whether the raster data is stored in memory or on disk.</span></span>
<span id="cb61-10"><a href="data-cubes-or-spatraster.html#cb61-10" tabindex="-1"></a><span class="fu">inMemory</span>(ras_stack[[<span class="dv">1</span>]]) </span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="data-cubes-or-spatraster.html#cb63-1" tabindex="-1"></a><span class="co"># Method 2: Using pipes to create raster layers from the raster location</span></span>
<span id="cb63-2"><a href="data-cubes-or-spatraster.html#cb63-2" tabindex="-1"></a><span class="fu">library</span>(tidyr) <span class="co"># For piping</span></span>
<span id="cb63-3"><a href="data-cubes-or-spatraster.html#cb63-3" tabindex="-1"></a>ras_list <span class="ot">=</span> ras_path <span class="sc">%&gt;%</span>  purrr<span class="sc">::</span><span class="fu">map</span>(<span class="sc">~</span> <span class="fu">rast</span>(.x))  <span class="co"># Import the raster</span></span>
<span id="cb63-4"><a href="data-cubes-or-spatraster.html#cb63-4" tabindex="-1"></a>ras_stack <span class="ot">=</span> <span class="fu">rast</span>(ras_list)  <span class="co"># Convert RasterStack to RasterBrick</span></span>
<span id="cb63-5"><a href="data-cubes-or-spatraster.html#cb63-5" tabindex="-1"></a></span>
<span id="cb63-6"><a href="data-cubes-or-spatraster.html#cb63-6" tabindex="-1"></a><span class="co"># Method 3: Using for loop to create raster layers from the raster location</span></span>
<span id="cb63-7"><a href="data-cubes-or-spatraster.html#cb63-7" tabindex="-1"></a>ras_stack<span class="ot">=</span><span class="fu">rast</span>()</span>
<span id="cb63-8"><a href="data-cubes-or-spatraster.html#cb63-8" tabindex="-1"></a><span class="cf">for</span> (nRun <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(ras_path)){</span>
<span id="cb63-9"><a href="data-cubes-or-spatraster.html#cb63-9" tabindex="-1"></a>  ras_stack<span class="ot">=</span><span class="fu">c</span>(ras_stack,<span class="fu">rast</span>(ras_path[[nRun]]))</span>
<span id="cb63-10"><a href="data-cubes-or-spatraster.html#cb63-10" tabindex="-1"></a>}</span>
<span id="cb63-11"><a href="data-cubes-or-spatraster.html#cb63-11" tabindex="-1"></a></span>
<span id="cb63-12"><a href="data-cubes-or-spatraster.html#cb63-12" tabindex="-1"></a><span class="co"># Check dimension of data cube</span></span>
<span id="cb63-13"><a href="data-cubes-or-spatraster.html#cb63-13" tabindex="-1"></a><span class="fu">dim</span>(ras_stack) <span class="co">#[x: y: z]- 23 raster layers with 456 x 964 cells</span></span></code></pre></div>
<pre><code>## [1] 456 964  23</code></pre>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="data-cubes-or-spatraster.html#cb65-1" tabindex="-1"></a><span class="co"># Number of layers in raster brick</span></span>
<span id="cb65-2"><a href="data-cubes-or-spatraster.html#cb65-2" tabindex="-1"></a><span class="fu">nlyr</span>(ras_stack)</span></code></pre></div>
<pre><code>## [1] 23</code></pre>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="data-cubes-or-spatraster.html#cb67-1" tabindex="-1"></a><span class="co"># Check variable names </span></span>
<span id="cb67-2"><a href="data-cubes-or-spatraster.html#cb67-2" tabindex="-1"></a><span class="fu">names</span>(ras_stack)</span></code></pre></div>
<pre><code>##  [1] &quot;NDVI_resamp_2016-01-01&quot; &quot;NDVI_resamp_2016-01-17&quot; &quot;NDVI_resamp_2016-02-02&quot;
##  [4] &quot;NDVI_resamp_2016-02-18&quot; &quot;NDVI_resamp_2016-03-05&quot; &quot;NDVI_resamp_2016-03-21&quot;
##  [7] &quot;NDVI_resamp_2016-04-06&quot; &quot;NDVI_resamp_2016-04-22&quot; &quot;NDVI_resamp_2016-05-08&quot;
## [10] &quot;NDVI_resamp_2016-05-24&quot; &quot;NDVI_resamp_2016-06-09&quot; &quot;NDVI_resamp_2016-06-25&quot;
## [13] &quot;NDVI_resamp_2016-07-11&quot; &quot;NDVI_resamp_2016-07-27&quot; &quot;NDVI_resamp_2016-08-12&quot;
## [16] &quot;NDVI_resamp_2016-08-28&quot; &quot;NDVI_resamp_2016-09-13&quot; &quot;NDVI_resamp_2016-09-29&quot;
## [19] &quot;NDVI_resamp_2016-10-15&quot; &quot;NDVI_resamp_2016-10-31&quot; &quot;NDVI_resamp_2016-11-16&quot;
## [22] &quot;NDVI_resamp_2016-12-02&quot; &quot;NDVI_resamp_2016-12-18&quot;</code></pre>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="data-cubes-or-spatraster.html#cb69-1" tabindex="-1"></a><span class="co"># Subset raster stack/brick (notice the double [[]] bracket and similarity to lists)</span></span>
<span id="cb69-2"><a href="data-cubes-or-spatraster.html#cb69-2" tabindex="-1"></a>sub_ras_stack<span class="ot">=</span>ras_stack[[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">12</span>)]] <span class="co">#Select 1st, 3rd, 5th, 10th and 12th layers</span></span>
<span id="cb69-3"><a href="data-cubes-or-spatraster.html#cb69-3" tabindex="-1"></a></span>
<span id="cb69-4"><a href="data-cubes-or-spatraster.html#cb69-4" tabindex="-1"></a><span class="co">#Try subsetting with dates:</span></span>
<span id="cb69-5"><a href="data-cubes-or-spatraster.html#cb69-5" tabindex="-1"></a>Season<span class="ot">&lt;-</span><span class="fu">str_subset</span>(<span class="at">string =</span> <span class="fu">names</span>(ras_stack), <span class="at">pattern =</span> <span class="fu">c</span>(<span class="st">&quot;20..-0[3/4/5]&quot;</span>)) </span>
<span id="cb69-6"><a href="data-cubes-or-spatraster.html#cb69-6" tabindex="-1"></a>ras_stack[[Season]]</span></code></pre></div>
<pre><code>## class       : SpatRaster 
## dimensions  : 456, 964, 6  (nrow, ncol, nlyr)
## resolution  : 0.373444, 0.373444  (x, y)
## extent      : -180, 180, -85.24595, 85.0445  (xmin, xmax, ymin, ymax)
## coord. ref. : lon/lat WGS 84 (EPSG:4326) 
## sources     : NDVI_resamp_2016-03-05.tif  
##               NDVI_resamp_2016-03-21.tif  
##               NDVI_resamp_2016-04-06.tif  
##               ... and 3 more sources
## names       : NDVI_~03-05, NDVI_~03-21, NDVI_~04-06, NDVI_~04-22, NDVI_~05-08, NDVI_~05-24 
## min values  :  -0.2000000,   -0.175517,  -0.1699783,  -0.1848017,   -0.199075,  -0.1863334 
## max values  :   0.9168695,    0.909500,   0.9042087,   0.9123000,    0.944600,   0.8917526</code></pre>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="data-cubes-or-spatraster.html#cb71-1" tabindex="-1"></a><span class="co">#~~ Plot first 4 elements of NDVI SpatRaster</span></span>
<span id="cb71-2"><a href="data-cubes-or-spatraster.html#cb71-2" tabindex="-1"></a><span class="co"># Function to add shapefile to a raster plot</span></span>
<span id="cb71-3"><a href="data-cubes-or-spatraster.html#cb71-3" tabindex="-1"></a>addCoastlines<span class="ot">=</span><span class="cf">function</span>(){</span>
<span id="cb71-4"><a href="data-cubes-or-spatraster.html#cb71-4" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="fu">vect</span>(coastlines), <span class="at">add=</span><span class="cn">TRUE</span>)   <span class="co">#convert &#39;coastlines&#39; to vector format</span></span>
<span id="cb71-5"><a href="data-cubes-or-spatraster.html#cb71-5" tabindex="-1"></a>  } </span>
<span id="cb71-6"><a href="data-cubes-or-spatraster.html#cb71-6" tabindex="-1"></a></span>
<span id="cb71-7"><a href="data-cubes-or-spatraster.html#cb71-7" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(sub_ras_stack[[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]],  <span class="co"># Select raster layers to plot</span></span>
<span id="cb71-8"><a href="data-cubes-or-spatraster.html#cb71-8" tabindex="-1"></a>     <span class="at">col=</span>mypal2,                   <span class="co"># Specify colormap</span></span>
<span id="cb71-9"><a href="data-cubes-or-spatraster.html#cb71-9" tabindex="-1"></a>     <span class="at">asp=</span><span class="cn">NA</span>,                       <span class="co"># Aspect ratio= NA</span></span>
<span id="cb71-10"><a href="data-cubes-or-spatraster.html#cb71-10" tabindex="-1"></a>     <span class="at">fun=</span>addCoastlines)            <span class="co"># Add coastline to each layer</span></span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-16-1.png" width="672" /></p>
<p><strong>Expert Note: For memory intensive rasters to brick formation, the “for” loop method may be better to avoid memory bottleneck.</strong></p>
</div>
<div id="geospatial-operations-on-spatraster" class="section level2 hasAnchor" number="5.2">
<h2><span class="header-section-number">5.2</span> Geospatial operations on SpatRaster<a href="data-cubes-or-spatraster.html#geospatial-operations-on-spatraster" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In this section, we will demonstrate application of several operations on SpatRaster for e.g. extracting time series at user-defined locations, spatial data extraction using spatial polygons/raster, crop and masking of SpatRaster.</p>
<div id="time-series-extraction-from-spatraster" class="section level3 hasAnchor" number="5.2.1">
<h3><span class="header-section-number">5.2.1</span> Time-series extraction from SpatRaster<a href="data-cubes-or-spatraster.html#time-series-extraction-from-spatraster" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Raster extraction is the process of identifying and returning the values associated with a ‘target’ raster at specific locations, based on a vector object. The results depend on the type of vector object used (points, lines or polygons) and arguments passed to the terra::extract() function.</p>
<p>We will demonstrate two ways of extracting time series information from SpatRaster.</p>
<p><strong>Method 1</strong>: Using <code>terra::extract</code> function to extract time series data for specific location(s)</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="data-cubes-or-spatraster.html#cb72-1" tabindex="-1"></a><span class="do">###############################################################</span></span>
<span id="cb72-2"><a href="data-cubes-or-spatraster.html#cb72-2" tabindex="-1"></a><span class="co">#~~~~ Method 1.1: Extract values for a single location</span></span>
<span id="cb72-3"><a href="data-cubes-or-spatraster.html#cb72-3" tabindex="-1"></a></span>
<span id="cb72-4"><a href="data-cubes-or-spatraster.html#cb72-4" tabindex="-1"></a><span class="co"># User defined lat and long</span></span>
<span id="cb72-5"><a href="data-cubes-or-spatraster.html#cb72-5" tabindex="-1"></a>Long<span class="ot">=</span><span class="sc">-</span><span class="fl">96.33</span>; Lat<span class="ot">=</span><span class="fl">30.62</span> </span>
<span id="cb72-6"><a href="data-cubes-or-spatraster.html#cb72-6" tabindex="-1"></a><span class="co"># Creating a spatial vector object from the location coords</span></span>
<span id="cb72-7"><a href="data-cubes-or-spatraster.html#cb72-7" tabindex="-1"></a>college_station <span class="ot">=</span> <span class="fu">vect</span>(<span class="fu">SpatialPoints</span>(<span class="fu">cbind</span>(Long, Lat)))</span>
<span id="cb72-8"><a href="data-cubes-or-spatraster.html#cb72-8" tabindex="-1"></a></span>
<span id="cb72-9"><a href="data-cubes-or-spatraster.html#cb72-9" tabindex="-1"></a></span>
<span id="cb72-10"><a href="data-cubes-or-spatraster.html#cb72-10" tabindex="-1"></a><span class="co"># Extract time series for the location</span></span>
<span id="cb72-11"><a href="data-cubes-or-spatraster.html#cb72-11" tabindex="-1"></a>ndvi_val<span class="ot">=</span>terra<span class="sc">::</span><span class="fu">extract</span>(ras_stack,</span>
<span id="cb72-12"><a href="data-cubes-or-spatraster.html#cb72-12" tabindex="-1"></a>                 college_station,    <span class="co"># lat-long as spatial locations</span></span>
<span id="cb72-13"><a href="data-cubes-or-spatraster.html#cb72-13" tabindex="-1"></a>                 <span class="at">method=</span><span class="st">&#39;bilinear&#39;</span>)  <span class="co"># or &quot;simple&quot; for nearest neighbor</span></span>
<span id="cb72-14"><a href="data-cubes-or-spatraster.html#cb72-14" tabindex="-1"></a></span>
<span id="cb72-15"><a href="data-cubes-or-spatraster.html#cb72-15" tabindex="-1"></a><span class="co"># Create a dataframe using the dates (derived from raster layer names) and extracted values</span></span>
<span id="cb72-16"><a href="data-cubes-or-spatraster.html#cb72-16" tabindex="-1"></a>ndvi_ts<span class="ot">=</span><span class="fu">data.frame</span>(<span class="at">Time=</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nlyr</span>(ras_stack)), <span class="co"># Sequence of retrieval time</span></span>
<span id="cb72-17"><a href="data-cubes-or-spatraster.html#cb72-17" tabindex="-1"></a>                   <span class="at">NDVI=</span><span class="fu">as.numeric</span>(ndvi_val[,<span class="sc">-</span><span class="dv">1</span>]))     <span class="co">#NDVI values</span></span>
<span id="cb72-18"><a href="data-cubes-or-spatraster.html#cb72-18" tabindex="-1"></a><span class="co"># Try changing Time to as.Date(substr(colnames(ndvi_val),13,22), format = &quot;%Y.%m.%d&quot;)</span></span>
<span id="cb72-19"><a href="data-cubes-or-spatraster.html#cb72-19" tabindex="-1"></a></span>
<span id="cb72-20"><a href="data-cubes-or-spatraster.html#cb72-20" tabindex="-1"></a><span class="co"># Plot NDVI time series extracted from raster brick/stack</span></span>
<span id="cb72-21"><a href="data-cubes-or-spatraster.html#cb72-21" tabindex="-1"></a><span class="fu">plot</span>(ndvi_ts, <span class="at">type=</span><span class="st">&quot;l&quot;</span>, <span class="at">col=</span><span class="st">&quot;maroon&quot;</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="fl">0.2</span>,<span class="fl">0.8</span>))</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
<p>Let us now extract values for multiple locations.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="data-cubes-or-spatraster.html#cb73-1" tabindex="-1"></a><span class="co">#~~~~ Method 1.2:  Extract values for multiple locations</span></span>
<span id="cb73-2"><a href="data-cubes-or-spatraster.html#cb73-2" tabindex="-1"></a><span class="co"># Import sample locations from contrasting hydroclimate</span></span>
<span id="cb73-3"><a href="data-cubes-or-spatraster.html#cb73-3" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb73-4"><a href="data-cubes-or-spatraster.html#cb73-4" tabindex="-1"></a>loc<span class="ot">=</span> <span class="fu">read_excel</span>(<span class="st">&quot;./SampleData-master/location_points.xlsx&quot;</span>)</span>
<span id="cb73-5"><a href="data-cubes-or-spatraster.html#cb73-5" tabindex="-1"></a><span class="fu">print</span>(loc)</span></code></pre></div>
<pre><code>## # A tibble: 3 × 4
##   Aridity   State     Longitude Latitude
##   &lt;chr&gt;     &lt;chr&gt;         &lt;dbl&gt;    &lt;dbl&gt;
## 1 Humid     Louisiana     -92.7     34.3
## 2 Arid      Nevada       -116.      38.7
## 3 Semi-arid Kansas        -99.8     38.8</code></pre>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="data-cubes-or-spatraster.html#cb75-1" tabindex="-1"></a><span class="co"># Extract time series using &quot;raster::extract&quot;</span></span>
<span id="cb75-2"><a href="data-cubes-or-spatraster.html#cb75-2" tabindex="-1"></a>loc_ndvi<span class="ot">=</span>terra<span class="sc">::</span><span class="fu">extract</span>(ras_stack,</span>
<span id="cb75-3"><a href="data-cubes-or-spatraster.html#cb75-3" tabindex="-1"></a>                         <span class="co">#2-column matrix or data.frame with lat-long</span></span>
<span id="cb75-4"><a href="data-cubes-or-spatraster.html#cb75-4" tabindex="-1"></a>                         loc[,<span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>],   </span>
<span id="cb75-5"><a href="data-cubes-or-spatraster.html#cb75-5" tabindex="-1"></a>                         <span class="co"># Use bilinear interpolation (or simple) option</span></span>
<span id="cb75-6"><a href="data-cubes-or-spatraster.html#cb75-6" tabindex="-1"></a>                         <span class="at">method=</span><span class="st">&#39;bilinear&#39;</span>)</span></code></pre></div>
<p>The rows in <code>loc_ndvi</code> variable corresponds to the points specified by the user, namely humid, arid and semi-arid locations. Let’s plot the extracted NDVI for three locations to look for patterns (influence on climate on vegetation).</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="data-cubes-or-spatraster.html#cb76-1" tabindex="-1"></a><span class="co"># Create a new data frame with dates of retrieval and NDVI for different hydroclimates</span></span>
<span id="cb76-2"><a href="data-cubes-or-spatraster.html#cb76-2" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb76-3"><a href="data-cubes-or-spatraster.html#cb76-3" tabindex="-1"></a>ndvi_locs <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">Date=</span><span class="fu">ymd</span>(<span class="fu">substr</span>(<span class="fu">colnames</span>(ndvi_val[,<span class="sc">-</span><span class="dv">1</span>]),<span class="dv">13</span>,<span class="dv">22</span>)),</span>
<span id="cb76-4"><a href="data-cubes-or-spatraster.html#cb76-4" tabindex="-1"></a>                      <span class="at">Humid =</span> <span class="fu">as.numeric</span>(loc_ndvi[<span class="dv">1</span>,<span class="sc">-</span><span class="dv">1</span>]),    <span class="co">#Location 1</span></span>
<span id="cb76-5"><a href="data-cubes-or-spatraster.html#cb76-5" tabindex="-1"></a>                      <span class="at">Arid =</span> <span class="fu">as.numeric</span>(loc_ndvi[<span class="dv">2</span>,<span class="sc">-</span><span class="dv">1</span>]),     <span class="co">#Location 2</span></span>
<span id="cb76-6"><a href="data-cubes-or-spatraster.html#cb76-6" tabindex="-1"></a>                      <span class="at">SemiArid =</span> <span class="fu">as.numeric</span>(loc_ndvi[<span class="dv">3</span>,<span class="sc">-</span><span class="dv">1</span>])) <span class="co">#Location 3</span></span>
<span id="cb76-7"><a href="data-cubes-or-spatraster.html#cb76-7" tabindex="-1"></a></span>
<span id="cb76-8"><a href="data-cubes-or-spatraster.html#cb76-8" tabindex="-1"></a><span class="co"># Convert data frame in &quot;long&quot; format for plotting using ggplot</span></span>
<span id="cb76-9"><a href="data-cubes-or-spatraster.html#cb76-9" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb76-10"><a href="data-cubes-or-spatraster.html#cb76-10" tabindex="-1"></a>df_long<span class="ot">=</span>ndvi_locs <span class="sc">%&gt;%</span> <span class="fu">gather</span>(Climate,NDVI,<span class="sc">-</span>Date)</span>
<span id="cb76-11"><a href="data-cubes-or-spatraster.html#cb76-11" tabindex="-1"></a><span class="co">#&quot;-&quot; sign indicates decreasing order</span></span>
<span id="cb76-12"><a href="data-cubes-or-spatraster.html#cb76-12" tabindex="-1"></a><span class="fu">head</span>(df_long,<span class="at">n=</span><span class="dv">4</span>)</span></code></pre></div>
<pre><code>##         Date Climate      NDVI
## 1 2016-01-01   Humid 0.5919486
## 2 2016-01-17   Humid 0.5762772
## 3 2016-02-02   Humid 0.5570874
## 4 2016-02-18   Humid 0.5752835</code></pre>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="data-cubes-or-spatraster.html#cb78-1" tabindex="-1"></a><span class="co"># Plot NDVI for different locations (hydroclimates). Do we see any pattern?? </span></span>
<span id="cb78-2"><a href="data-cubes-or-spatraster.html#cb78-2" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb78-3"><a href="data-cubes-or-spatraster.html#cb78-3" tabindex="-1"></a>l <span class="ot">=</span> <span class="fu">ggplot</span>(df_long,               <span class="co"># Dataframe with input Dataset </span></span>
<span id="cb78-4"><a href="data-cubes-or-spatraster.html#cb78-4" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">x=</span>Date,             <span class="co"># X-variable</span></span>
<span id="cb78-5"><a href="data-cubes-or-spatraster.html#cb78-5" tabindex="-1"></a>              <span class="at">y=</span>NDVI,             <span class="co"># Y-variable</span></span>
<span id="cb78-6"><a href="data-cubes-or-spatraster.html#cb78-6" tabindex="-1"></a>              <span class="at">group=</span>Climate)) <span class="sc">+</span>   <span class="co"># Group by climate </span></span>
<span id="cb78-7"><a href="data-cubes-or-spatraster.html#cb78-7" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color=</span>Climate))<span class="sc">+</span>  <span class="co"># Line color based on climate variable</span></span>
<span id="cb78-8"><a href="data-cubes-or-spatraster.html#cb78-8" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color=</span>Climate))<span class="sc">+</span> <span class="co"># Point color based on climate variable </span></span>
<span id="cb78-9"><a href="data-cubes-or-spatraster.html#cb78-9" tabindex="-1"></a>  <span class="fu">theme_classic</span>() </span>
<span id="cb78-10"><a href="data-cubes-or-spatraster.html#cb78-10" tabindex="-1"></a><span class="fu">print</span>(l)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
<p><strong>Method 2</strong>: Use <code>rowFromY</code> or <code>rowFromX</code> to find row and column number of the raster for the location.</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="data-cubes-or-spatraster.html#cb79-1" tabindex="-1"></a><span class="do">###############################################################</span></span>
<span id="cb79-2"><a href="data-cubes-or-spatraster.html#cb79-2" tabindex="-1"></a><span class="co">#~~~~ Method 2: Retrieve values using cell row and column number</span></span>
<span id="cb79-3"><a href="data-cubes-or-spatraster.html#cb79-3" tabindex="-1"></a>row <span class="ot">=</span> <span class="fu">rowFromY</span>(ras_stack[[<span class="dv">1</span>]], Lat)    <span class="co"># Gives row number for the selected Lat</span></span>
<span id="cb79-4"><a href="data-cubes-or-spatraster.html#cb79-4" tabindex="-1"></a>col <span class="ot">=</span> <span class="fu">colFromX</span>(ras_stack[[<span class="dv">1</span>]], Long)   <span class="co"># Gives column number for the selected Long</span></span>
<span id="cb79-5"><a href="data-cubes-or-spatraster.html#cb79-5" tabindex="-1"></a>ras_stack[row,col][<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]                <span class="co"># First five elements of data cube for selected x-y</span></span></code></pre></div>
<pre><code>##   NDVI_resamp_2016-01-01 NDVI_resamp_2016-01-17 NDVI_resamp_2016-02-02
## 1              0.5614925              0.5193725              0.4958409
##   NDVI_resamp_2016-02-18 NDVI_resamp_2016-03-05
## 1              0.5731566              0.6259534</code></pre>
</div>
<div id="spatial-extractionsummary-from-spatraster" class="section level3 hasAnchor" number="5.2.2">
<h3><span class="header-section-number">5.2.2</span> Spatial extraction/summary from SpatRaster<a href="data-cubes-or-spatraster.html#spatial-extractionsummary-from-spatraster" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Let’s try extracting values of SpatRaster (for all layers simultaneously) based on polygon features using <code>extract</code> function.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="data-cubes-or-spatraster.html#cb81-1" tabindex="-1"></a><span class="co">#~~~~ Method 1: Extract values based on spatial polygons</span></span>
<span id="cb81-2"><a href="data-cubes-or-spatraster.html#cb81-2" tabindex="-1"></a>IPCC_shp <span class="ot">=</span> <span class="fu">read_sf</span>(<span class="st">&quot;./SampleData-master/CMIP_land/CMIP_land.shp&quot;</span>)</span>
<span id="cb81-3"><a href="data-cubes-or-spatraster.html#cb81-3" tabindex="-1"></a></span>
<span id="cb81-4"><a href="data-cubes-or-spatraster.html#cb81-4" tabindex="-1"></a><span class="co"># Calculates the &#39;mean&#39; of all cells within each feature of &#39;IPCC_shp&#39; for each layers</span></span>
<span id="cb81-5"><a href="data-cubes-or-spatraster.html#cb81-5" tabindex="-1"></a>ndvi_sp <span class="ot">=</span> terra<span class="sc">::</span><span class="fu">extract</span>(ras_stack,   <span class="co"># Data cube</span></span>
<span id="cb81-6"><a href="data-cubes-or-spatraster.html#cb81-6" tabindex="-1"></a>                         <span class="fu">vect</span>(IPCC_shp),    <span class="co"># Shapefile for feature reference </span></span>
<span id="cb81-7"><a href="data-cubes-or-spatraster.html#cb81-7" tabindex="-1"></a>                         <span class="at">fun=</span>mean, </span>
<span id="cb81-8"><a href="data-cubes-or-spatraster.html#cb81-8" tabindex="-1"></a>                         <span class="at">na.rm=</span>T, </span>
<span id="cb81-9"><a href="data-cubes-or-spatraster.html#cb81-9" tabindex="-1"></a>                         <span class="co">#df=TRUE, </span></span>
<span id="cb81-10"><a href="data-cubes-or-spatraster.html#cb81-10" tabindex="-1"></a>                         <span class="at">method=</span><span class="st">&#39;bilinear&#39;</span>)</span>
<span id="cb81-11"><a href="data-cubes-or-spatraster.html#cb81-11" tabindex="-1"></a></span>
<span id="cb81-12"><a href="data-cubes-or-spatraster.html#cb81-12" tabindex="-1"></a><span class="fu">head</span>(ndvi_sp,<span class="at">n=</span><span class="dv">3</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code></pre></div>
<pre><code>##   ID NDVI_resamp_2016-01-01 NDVI_resamp_2016-01-17 NDVI_resamp_2016-02-02
## 1  1            -0.08325353          -3.320059e+38          -3.319744e+38
## 2  2             0.02765715          -2.329463e+38          -2.328498e+38
## 3  3             0.21922899          -1.435967e+37          -1.435967e+37
##   NDVI_resamp_2016-02-18
## 1          -3.319115e+38
## 2          -2.330106e+38
## 3          -1.435967e+37</code></pre>
<p>We can also use a classified raster like aridity data we previously used, to extract values corresponding to each class of values using <code>lapply</code> and selective filtering.
Note: The two rasters must have same extent and resolution.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="data-cubes-or-spatraster.html#cb83-1" tabindex="-1"></a><span class="co">#~~~~ Method 2: Extract values based on another raster</span></span>
<span id="cb83-2"><a href="data-cubes-or-spatraster.html#cb83-2" tabindex="-1"></a>aridity <span class="ot">=</span> <span class="fu">rast</span>(<span class="st">&quot;./SampleData-master/raster_files/aridity_36km.tif&quot;</span>)</span>
<span id="cb83-3"><a href="data-cubes-or-spatraster.html#cb83-3" tabindex="-1"></a></span>
<span id="cb83-4"><a href="data-cubes-or-spatraster.html#cb83-4" tabindex="-1"></a><span class="co"># Create an empty list to store extracted feature </span></span>
<span id="cb83-5"><a href="data-cubes-or-spatraster.html#cb83-5" tabindex="-1"></a>climate_ndvi <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb83-6"><a href="data-cubes-or-spatraster.html#cb83-6" tabindex="-1"></a><span class="co"># Extracts the time series of NDVI for pixels for each climate region</span></span>
<span id="cb83-7"><a href="data-cubes-or-spatraster.html#cb83-7" tabindex="-1"></a>climate_ndvi <span class="ot">=</span> <span class="fu">lapply</span>(<span class="fu">list</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>),<span class="cf">function</span>(x) (<span class="fu">na.omit</span>((ras_stack[aridity<span class="sc">==</span>x]))))</span>
<span id="cb83-8"><a href="data-cubes-or-spatraster.html#cb83-8" tabindex="-1"></a></span>
<span id="cb83-9"><a href="data-cubes-or-spatraster.html#cb83-9" tabindex="-1"></a><span class="co"># Calculate and store mean NDVI for each climate region</span></span>
<span id="cb83-10"><a href="data-cubes-or-spatraster.html#cb83-10" tabindex="-1"></a>climate_ndvi_mean <span class="ot">=</span> <span class="fu">lapply</span>(<span class="fu">list</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>),<span class="cf">function</span>(x) (<span class="fu">mean</span>(ras_stack[aridity<span class="sc">==</span>x], <span class="at">na.rm=</span><span class="cn">TRUE</span>)))</span>
<span id="cb83-11"><a href="data-cubes-or-spatraster.html#cb83-11" tabindex="-1"></a></span>
<span id="cb83-12"><a href="data-cubes-or-spatraster.html#cb83-12" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">unlist</span>(climate_ndvi_mean),</span>
<span id="cb83-13"><a href="data-cubes-or-spatraster.html#cb83-13" tabindex="-1"></a>     <span class="at">type =</span> <span class="st">&quot;b&quot;</span>, </span>
<span id="cb83-14"><a href="data-cubes-or-spatraster.html#cb83-14" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">&quot;Climate_NDVI_Mean&quot;</span>, </span>
<span id="cb83-15"><a href="data-cubes-or-spatraster.html#cb83-15" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">&quot;Aridity Index&quot;</span>)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-21-1.png" width="672" /></p>
</div>
<div id="crop-and-mask-spatraster" class="section level3 hasAnchor" number="5.2.3">
<h3><span class="header-section-number">5.2.3</span> Crop and mask SpatRaster<a href="data-cubes-or-spatraster.html#crop-and-mask-spatraster" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We will now <code>crop</code> and <code>mask</code> SpatRaster using shapefile from the disk or from imported shapefile from <code>spData::us_states</code>. <code>crop</code> function clips the raster to the <code>extent</code> provided. <code>mask</code> removes the area outside the provided shapefile. Alternatively, we can import shapefile from disk using <code>read_sf</code> function.</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="data-cubes-or-spatraster.html#cb84-1" tabindex="-1"></a><span class="co"># Import polygons for polygons for USA at level 1 i.e. state from disk</span></span>
<span id="cb84-2"><a href="data-cubes-or-spatraster.html#cb84-2" tabindex="-1"></a></span>
<span id="cb84-3"><a href="data-cubes-or-spatraster.html#cb84-3" tabindex="-1"></a>state_shapefile <span class="ot">=</span> <span class="fu">read_sf</span>(<span class="st">&quot;./SampleData-master/USA_states/cb_2018_us_state_5m.shp&quot;</span>)</span>
<span id="cb84-4"><a href="data-cubes-or-spatraster.html#cb84-4" tabindex="-1"></a></span>
<span id="cb84-5"><a href="data-cubes-or-spatraster.html#cb84-5" tabindex="-1"></a><span class="co"># Alternatively, use dataset from &#39;spData&#39; package &#39;spData::us_states&#39;</span></span>
<span id="cb84-6"><a href="data-cubes-or-spatraster.html#cb84-6" tabindex="-1"></a></span>
<span id="cb84-7"><a href="data-cubes-or-spatraster.html#cb84-7" tabindex="-1"></a><span class="co"># Print variable names</span></span>
<span id="cb84-8"><a href="data-cubes-or-spatraster.html#cb84-8" tabindex="-1"></a><span class="fu">names</span>(state_shapefile)</span></code></pre></div>
<pre><code>##  [1] &quot;STATEFP&quot;  &quot;STATENS&quot;  &quot;AFFGEOID&quot; &quot;GEOID&quot;    &quot;STUSPS&quot;   &quot;NAME&quot;    
##  [7] &quot;LSAD&quot;     &quot;ALAND&quot;    &quot;AWATER&quot;   &quot;geometry&quot;</code></pre>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="data-cubes-or-spatraster.html#cb86-1" tabindex="-1"></a><span class="co"># Print state/ territory names</span></span>
<span id="cb86-2"><a href="data-cubes-or-spatraster.html#cb86-2" tabindex="-1"></a><span class="fu">print</span>(state_shapefile<span class="sc">$</span>NAME)</span></code></pre></div>
<pre><code>##  [1] &quot;Nebraska&quot;                                    
##  [2] &quot;Washington&quot;                                  
##  [3] &quot;New Mexico&quot;                                  
##  [4] &quot;South Dakota&quot;                                
##  [5] &quot;Texas&quot;                                       
##  [6] &quot;California&quot;                                  
##  [7] &quot;Kentucky&quot;                                    
##  [8] &quot;Ohio&quot;                                        
##  [9] &quot;Alabama&quot;                                     
## [10] &quot;Georgia&quot;                                     
## [11] &quot;Wisconsin&quot;                                   
## [12] &quot;Oregon&quot;                                      
## [13] &quot;Pennsylvania&quot;                                
## [14] &quot;Mississippi&quot;                                 
## [15] &quot;Missouri&quot;                                    
## [16] &quot;North Carolina&quot;                              
## [17] &quot;Oklahoma&quot;                                    
## [18] &quot;West Virginia&quot;                               
## [19] &quot;New York&quot;                                    
## [20] &quot;Indiana&quot;                                     
## [21] &quot;Kansas&quot;                                      
## [22] &quot;Idaho&quot;                                       
## [23] &quot;Nevada&quot;                                      
## [24] &quot;Vermont&quot;                                     
## [25] &quot;Montana&quot;                                     
## [26] &quot;Minnesota&quot;                                   
## [27] &quot;North Dakota&quot;                                
## [28] &quot;Hawaii&quot;                                      
## [29] &quot;Arizona&quot;                                     
## [30] &quot;Delaware&quot;                                    
## [31] &quot;Rhode Island&quot;                                
## [32] &quot;Colorado&quot;                                    
## [33] &quot;Utah&quot;                                        
## [34] &quot;Virginia&quot;                                    
## [35] &quot;Wyoming&quot;                                     
## [36] &quot;Louisiana&quot;                                   
## [37] &quot;Michigan&quot;                                    
## [38] &quot;Massachusetts&quot;                               
## [39] &quot;Florida&quot;                                     
## [40] &quot;United States Virgin Islands&quot;                
## [41] &quot;Connecticut&quot;                                 
## [42] &quot;New Jersey&quot;                                  
## [43] &quot;Maryland&quot;                                    
## [44] &quot;South Carolina&quot;                              
## [45] &quot;Maine&quot;                                       
## [46] &quot;New Hampshire&quot;                               
## [47] &quot;District of Columbia&quot;                        
## [48] &quot;Guam&quot;                                        
## [49] &quot;Commonwealth of the Northern Mariana Islands&quot;
## [50] &quot;American Samoa&quot;                              
## [51] &quot;Iowa&quot;                                        
## [52] &quot;Puerto Rico&quot;                                 
## [53] &quot;Arkansas&quot;                                    
## [54] &quot;Tennessee&quot;                                   
## [55] &quot;Illinois&quot;                                    
## [56] &quot;Alaska&quot;</code></pre>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="data-cubes-or-spatraster.html#cb88-1" tabindex="-1"></a><span class="co"># Exclude states outside of CONUS </span></span>
<span id="cb88-2"><a href="data-cubes-or-spatraster.html#cb88-2" tabindex="-1"></a>conus <span class="ot">=</span> state_shapefile[<span class="sc">!</span>(state_shapefile<span class="sc">$</span>NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;Alaska&quot;</span>,<span class="st">&quot;Hawaii&quot;</span>,<span class="st">&quot;American Samoa&quot;</span>,</span>
<span id="cb88-3"><a href="data-cubes-or-spatraster.html#cb88-3" tabindex="-1"></a>                        <span class="st">&quot;United States Virgin Islands&quot;</span>,<span class="st">&quot;Guam&quot;</span>, <span class="st">&quot;Puerto Rico&quot;</span>,</span>
<span id="cb88-4"><a href="data-cubes-or-spatraster.html#cb88-4" tabindex="-1"></a>                        <span class="st">&quot;Commonwealth of the Northern Mariana Islands&quot;</span>)),] </span>
<span id="cb88-5"><a href="data-cubes-or-spatraster.html#cb88-5" tabindex="-1"></a></span>
<span id="cb88-6"><a href="data-cubes-or-spatraster.html#cb88-6" tabindex="-1"></a><span class="co"># plot CONUS as a vector using terra package</span></span>
<span id="cb88-7"><a href="data-cubes-or-spatraster.html#cb88-7" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(<span class="fu">vect</span>(conus)) </span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-22-1.png" width="672" /></p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="data-cubes-or-spatraster.html#cb89-1" tabindex="-1"></a><span class="co"># Crop SpatRaster using USA polygon</span></span>
<span id="cb89-2"><a href="data-cubes-or-spatraster.html#cb89-2" tabindex="-1"></a>usa_crop <span class="ot">=</span> <span class="fu">crop</span>(ras_stack, <span class="fu">ext</span>(conus))       <span class="co"># Crop raster to CONUS extent</span></span>
<span id="cb89-3"><a href="data-cubes-or-spatraster.html#cb89-3" tabindex="-1"></a></span>
<span id="cb89-4"><a href="data-cubes-or-spatraster.html#cb89-4" tabindex="-1"></a><span class="co"># Plot cropped raster</span></span>
<span id="cb89-5"><a href="data-cubes-or-spatraster.html#cb89-5" tabindex="-1"></a><span class="fu">plot</span>(usa_crop[[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]], <span class="at">col=</span>mypal2)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-22-2.png" width="672" /></p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="data-cubes-or-spatraster.html#cb90-1" tabindex="-1"></a><span class="co"># Mask SpatRaster using USA polygon</span></span>
<span id="cb90-2"><a href="data-cubes-or-spatraster.html#cb90-2" tabindex="-1"></a>ndvi_mask_usa <span class="ot">=</span> terra<span class="sc">::</span><span class="fu">mask</span>(usa_crop, <span class="fu">vect</span>(conus))    <span class="co"># Mask raster to CONUS </span></span>
<span id="cb90-3"><a href="data-cubes-or-spatraster.html#cb90-3" tabindex="-1"></a></span>
<span id="cb90-4"><a href="data-cubes-or-spatraster.html#cb90-4" tabindex="-1"></a><span class="co"># Mask SpatRaster using USA polygon</span></span>
<span id="cb90-5"><a href="data-cubes-or-spatraster.html#cb90-5" tabindex="-1"></a><span class="fu">plot</span>(ndvi_mask_usa[[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]], </span>
<span id="cb90-6"><a href="data-cubes-or-spatraster.html#cb90-6" tabindex="-1"></a>     <span class="at">col=</span>mypal2, </span>
<span id="cb90-7"><a href="data-cubes-or-spatraster.html#cb90-7" tabindex="-1"></a>     <span class="at">fun=</span><span class="cf">function</span>(){<span class="fu">plot</span>(<span class="fu">vect</span>(conus), <span class="at">add=</span><span class="cn">TRUE</span>)} <span class="co"># Add background states</span></span>
<span id="cb90-8"><a href="data-cubes-or-spatraster.html#cb90-8" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-22-3.png" width="672" /></p>
<p>Let’s crop raster for selected US states.</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="data-cubes-or-spatraster.html#cb91-1" tabindex="-1"></a><span class="co"># Mask raster for selected states</span></span>
<span id="cb91-2"><a href="data-cubes-or-spatraster.html#cb91-2" tabindex="-1"></a>states <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&#39;Colorado&#39;</span>,<span class="st">&#39;Texas&#39;</span>,<span class="st">&#39;New Mexico&#39;</span>)</span>
<span id="cb91-3"><a href="data-cubes-or-spatraster.html#cb91-3" tabindex="-1"></a></span>
<span id="cb91-4"><a href="data-cubes-or-spatraster.html#cb91-4" tabindex="-1"></a><span class="co"># Subset the selected states from CONUS shapefile</span></span>
<span id="cb91-5"><a href="data-cubes-or-spatraster.html#cb91-5" tabindex="-1"></a>state_plot <span class="ot">=</span> state_shapefile[(state_shapefile<span class="sc">$</span>NAME <span class="sc">%in%</span> states),] </span>
<span id="cb91-6"><a href="data-cubes-or-spatraster.html#cb91-6" tabindex="-1"></a></span>
<span id="cb91-7"><a href="data-cubes-or-spatraster.html#cb91-7" tabindex="-1"></a><span class="co"># Raster operation</span></span>
<span id="cb91-8"><a href="data-cubes-or-spatraster.html#cb91-8" tabindex="-1"></a>states_trim <span class="ot">=</span> <span class="fu">crop</span>(ras_stack, <span class="fu">ext</span>(state_plot))                <span class="co"># Crop raster</span></span>
<span id="cb91-9"><a href="data-cubes-or-spatraster.html#cb91-9" tabindex="-1"></a>ndvi_mask_states <span class="ot">=</span> terra<span class="sc">::</span><span class="fu">mask</span>(states_trim, <span class="fu">vect</span>(state_plot)) <span class="co"># Mask</span></span>
<span id="cb91-10"><a href="data-cubes-or-spatraster.html#cb91-10" tabindex="-1"></a></span>
<span id="cb91-11"><a href="data-cubes-or-spatraster.html#cb91-11" tabindex="-1"></a><span class="co"># Plot raster and shapefile</span></span>
<span id="cb91-12"><a href="data-cubes-or-spatraster.html#cb91-12" tabindex="-1"></a><span class="fu">plot</span>(ndvi_mask_states[[<span class="dv">1</span>]], </span>
<span id="cb91-13"><a href="data-cubes-or-spatraster.html#cb91-13" tabindex="-1"></a>     <span class="at">col=</span>mypal2, </span>
<span id="cb91-14"><a href="data-cubes-or-spatraster.html#cb91-14" tabindex="-1"></a>     <span class="at">fun=</span><span class="cf">function</span>(){<span class="fu">plot</span>(<span class="fu">vect</span>(conus), <span class="at">add=</span><span class="cn">TRUE</span>)} <span class="co"># Add background states</span></span>
<span id="cb91-15"><a href="data-cubes-or-spatraster.html#cb91-15" tabindex="-1"></a>     )</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-23-1.png" width="672" /></p>
</div>
</div>
<div id="layer-wise-operations-on-spatraster" class="section level2 hasAnchor" number="5.3">
<h2><span class="header-section-number">5.3</span> Layer-wise operations on SpatRaster<a href="data-cubes-or-spatraster.html#layer-wise-operations-on-spatraster" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We will demonstrate common layer-wise arithmetic operations, summary statistics and data transformation on SpatRaster.</p>
<center>
<img src="SampleData-master/images/Layerwiseoperation2022.png" style="width:50.0%" />
</center>
<p><br></p>
<p>Arithmetic operations a.k.a <code>arith-generic</code> (+, -, *, /, ^, %%, %/%) on SpatRaster closely resemble simple vector-like operations. More details on <code>arith-generic</code> can be found here: <a href="https://rdrr.io/cran/terra/man/arith-generic.html" class="uri">https://rdrr.io/cran/terra/man/arith-generic.html</a>.
For layer-wise summary statistics and user-defined operations, we will use <code>global</code> function.</p>
<p>Let’s try some layer-wise cell-statistics:</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="data-cubes-or-spatraster.html#cb92-1" tabindex="-1"></a><span class="do">###############################################################</span></span>
<span id="cb92-2"><a href="data-cubes-or-spatraster.html#cb92-2" tabindex="-1"></a><span class="co">#~~~ Layer-wise cell-statistics </span></span>
<span id="cb92-3"><a href="data-cubes-or-spatraster.html#cb92-3" tabindex="-1"></a><span class="co"># Layer-wise Mean</span></span>
<span id="cb92-4"><a href="data-cubes-or-spatraster.html#cb92-4" tabindex="-1"></a><span class="fu">global</span>(sub_ras_stack, mean, <span class="at">na.rm=</span> T) <span class="co"># Mean of each raster layer. Try modal, median, min etc. </span></span></code></pre></div>
<pre><code>##                             mean
## NDVI_resamp_2016-01-01 0.2840846
## NDVI_resamp_2016-02-02 0.2948298
## NDVI_resamp_2016-03-05 0.3057182
## NDVI_resamp_2016-05-24 0.4618550
## NDVI_resamp_2016-06-25 0.4997354</code></pre>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="data-cubes-or-spatraster.html#cb94-1" tabindex="-1"></a><span class="co"># Layer-wise quantiles</span></span>
<span id="cb94-2"><a href="data-cubes-or-spatraster.html#cb94-2" tabindex="-1"></a><span class="fu">global</span>(sub_ras_stack, quantile, <span class="at">probs=</span><span class="fu">c</span>(.<span class="dv">25</span>,.<span class="dv">75</span>), <span class="at">na.rm=</span> T)</span></code></pre></div>
<pre><code>##                              X25.      X75.
## NDVI_resamp_2016-01-01 0.07188153 0.5135894
## NDVI_resamp_2016-02-02 0.08442930 0.5177374
## NDVI_resamp_2016-03-05 0.09917563 0.5113073
## NDVI_resamp_2016-05-24 0.23671686 0.6695234
## NDVI_resamp_2016-06-25 0.26000642 0.7303487</code></pre>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="data-cubes-or-spatraster.html#cb96-1" tabindex="-1"></a><span class="co"># User-defined statistics by defining own function</span></span>
<span id="cb96-2"><a href="data-cubes-or-spatraster.html#cb96-2" tabindex="-1"></a>quant_fun <span class="ot">=</span> <span class="cf">function</span>(x) {<span class="fu">quantile</span>(x, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.75</span>), <span class="at">na.rm=</span><span class="cn">TRUE</span>)} </span>
<span id="cb96-3"><a href="data-cubes-or-spatraster.html#cb96-3" tabindex="-1"></a><span class="fu">global</span>(sub_ras_stack, quant_fun) <span class="co"># 25th, and 75th percentile of each layer</span></span></code></pre></div>
<pre><code>##                              X25.      X75.
## NDVI_resamp_2016-01-01 0.07188153 0.5135894
## NDVI_resamp_2016-02-02 0.08442930 0.5177374
## NDVI_resamp_2016-03-05 0.09917563 0.5113073
## NDVI_resamp_2016-05-24 0.23671686 0.6695234
## NDVI_resamp_2016-06-25 0.26000642 0.7303487</code></pre>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="data-cubes-or-spatraster.html#cb98-1" tabindex="-1"></a><span class="co"># Custom function for mean, variance and skewness</span></span>
<span id="cb98-2"><a href="data-cubes-or-spatraster.html#cb98-2" tabindex="-1"></a>my_fun <span class="ot">=</span> <span class="cf">function</span>(x){ </span>
<span id="cb98-3"><a href="data-cubes-or-spatraster.html#cb98-3" tabindex="-1"></a>  meanVal<span class="ot">=</span><span class="fu">mean</span>(x, <span class="at">na.rm=</span><span class="cn">TRUE</span>)              <span class="co"># Mean </span></span>
<span id="cb98-4"><a href="data-cubes-or-spatraster.html#cb98-4" tabindex="-1"></a>  varVal<span class="ot">=</span><span class="fu">var</span>(x, <span class="at">na.rm=</span><span class="cn">TRUE</span>)                <span class="co"># Variance</span></span>
<span id="cb98-5"><a href="data-cubes-or-spatraster.html#cb98-5" tabindex="-1"></a>  skewVal<span class="ot">=</span>moments<span class="sc">::</span><span class="fu">skewness</span>(x, <span class="at">na.rm=</span><span class="cn">TRUE</span>) <span class="co"># Skewness</span></span>
<span id="cb98-6"><a href="data-cubes-or-spatraster.html#cb98-6" tabindex="-1"></a>  output<span class="ot">=</span><span class="fu">c</span>(meanVal,varVal,skewVal)         <span class="co"># Combine all statistics</span></span>
<span id="cb98-7"><a href="data-cubes-or-spatraster.html#cb98-7" tabindex="-1"></a>  <span class="fu">names</span>(output)<span class="ot">=</span><span class="fu">c</span>(<span class="st">&quot;Mean&quot;</span>, <span class="st">&quot;Var&quot;</span>,<span class="st">&quot;Skew&quot;</span>)    <span class="co"># Rename output variables</span></span>
<span id="cb98-8"><a href="data-cubes-or-spatraster.html#cb98-8" tabindex="-1"></a>  <span class="fu">return</span>(output)                           <span class="co"># Return output</span></span>
<span id="cb98-9"><a href="data-cubes-or-spatraster.html#cb98-9" tabindex="-1"></a>} </span>
<span id="cb98-10"><a href="data-cubes-or-spatraster.html#cb98-10" tabindex="-1"></a></span>
<span id="cb98-11"><a href="data-cubes-or-spatraster.html#cb98-11" tabindex="-1"></a><span class="fu">global</span>(sub_ras_stack, my_fun) <span class="co"># Mean, Variance and skewness of each layer</span></span></code></pre></div>
<pre><code>##                             Mean        Var       Skew
## NDVI_resamp_2016-01-01 0.2840846 0.07224034  0.5409973
## NDVI_resamp_2016-02-02 0.2948298 0.06677124  0.5075244
## NDVI_resamp_2016-03-05 0.3057182 0.06171894  0.5018285
## NDVI_resamp_2016-05-24 0.4618550 0.05944947 -0.2721941
## NDVI_resamp_2016-06-25 0.4997354 0.06587261 -0.3392214</code></pre>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="data-cubes-or-spatraster.html#cb100-1" tabindex="-1"></a><span class="co">#You can also use summary() to retrieve common descriptive statistics</span></span>
<span id="cb100-2"><a href="data-cubes-or-spatraster.html#cb100-2" tabindex="-1"></a><span class="fu">summary</span>(sub_ras_stack)</span></code></pre></div>
<pre><code>##  NDVI_resamp_2016.01.01 NDVI_resamp_2016.02.02 NDVI_resamp_2016.03.05
##  Min.   :-0.17          Min.   :-0.19          Min.   :-0.16         
##  1st Qu.: 0.07          1st Qu.: 0.08          1st Qu.: 0.10         
##  Median : 0.19          Median : 0.22          Median : 0.23         
##  Mean   : 0.28          Mean   : 0.29          Mean   : 0.31         
##  3rd Qu.: 0.51          3rd Qu.: 0.52          3rd Qu.: 0.51         
##  Max.   : 0.92          Max.   : 0.90          Max.   : 0.90         
##  NA&#39;s   :77736          NA&#39;s   :77094          NA&#39;s   :77106         
##  NDVI_resamp_2016.05.24 NDVI_resamp_2016.06.25
##  Min.   :-0.18          Min.   :-0.19         
##  1st Qu.: 0.24          1st Qu.: 0.26         
##  Median : 0.50          Median : 0.55         
##  Mean   : 0.46          Mean   : 0.50         
##  3rd Qu.: 0.67          3rd Qu.: 0.73         
##  Max.   : 0.89          Max.   : 0.91         
##  NA&#39;s   :77100          NA&#39;s   :77091</code></pre>
<p>Global cell-statistics can be calculated by converting SpatRaster to a <strong>vector</strong> and then using regular statistics functions. We will use <code>as.vector()</code> to convert rasters to vector array before arithmetic operation.</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="data-cubes-or-spatraster.html#cb102-1" tabindex="-1"></a><span class="do">###############################################################</span></span>
<span id="cb102-2"><a href="data-cubes-or-spatraster.html#cb102-2" tabindex="-1"></a><span class="co">#~~~ Global cell-statistics</span></span>
<span id="cb102-3"><a href="data-cubes-or-spatraster.html#cb102-3" tabindex="-1"></a></span>
<span id="cb102-4"><a href="data-cubes-or-spatraster.html#cb102-4" tabindex="-1"></a><span class="co"># By vectorizing the SpatRaster and finding statistics</span></span>
<span id="cb102-5"><a href="data-cubes-or-spatraster.html#cb102-5" tabindex="-1"></a>min_val<span class="ot">=</span><span class="fu">min</span>(<span class="fu">as.vector</span>(sub_ras_stack), <span class="at">na.rm=</span>T) </span>
<span id="cb102-6"><a href="data-cubes-or-spatraster.html#cb102-6" tabindex="-1"></a>max_val<span class="ot">=</span><span class="fu">max</span>(<span class="fu">as.vector</span>(sub_ras_stack), <span class="at">na.rm=</span>T)</span>
<span id="cb102-7"><a href="data-cubes-or-spatraster.html#cb102-7" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(min_val,max_val))</span></code></pre></div>
<pre><code>## [1] -0.20000  0.95065</code></pre>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="data-cubes-or-spatraster.html#cb104-1" tabindex="-1"></a><span class="co"># Another example of statistics of vectorized SpatRaster</span></span>
<span id="cb104-2"><a href="data-cubes-or-spatraster.html#cb104-2" tabindex="-1"></a>quant<span class="ot">=</span><span class="fu">quantile</span>(<span class="fu">as.vector</span>(sub_ras_stack), <span class="fu">c</span>(<span class="fl">0.01</span>,<span class="fl">0.99</span>), <span class="at">na.rm=</span><span class="cn">TRUE</span>) <span class="co">#1st and 99th percentiles</span></span>
<span id="cb104-3"><a href="data-cubes-or-spatraster.html#cb104-3" tabindex="-1"></a><span class="fu">print</span>(quant)</span></code></pre></div>
<pre><code>##          1%         99% 
## -0.05663428  0.84776928</code></pre>
<p>Layer-wise arithmetic operations on SpatRaster:</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="data-cubes-or-spatraster.html#cb106-1" tabindex="-1"></a><span class="do">###############################################################</span></span>
<span id="cb106-2"><a href="data-cubes-or-spatraster.html#cb106-2" tabindex="-1"></a><span class="co">#~~~ Layer-wise operations on SpatRaster</span></span>
<span id="cb106-3"><a href="data-cubes-or-spatraster.html#cb106-3" tabindex="-1"></a></span>
<span id="cb106-4"><a href="data-cubes-or-spatraster.html#cb106-4" tabindex="-1"></a><span class="co"># Arithmetic operations on SpatRaster are same as lists</span></span>
<span id="cb106-5"><a href="data-cubes-or-spatraster.html#cb106-5" tabindex="-1"></a>add <span class="ot">=</span> sub_ras_stack<span class="sc">+</span><span class="dv">10</span>                  <span class="co"># Add a number to raster layers</span></span>
<span id="cb106-6"><a href="data-cubes-or-spatraster.html#cb106-6" tabindex="-1"></a>mult <span class="ot">=</span> sub_ras_stack<span class="sc">*</span><span class="dv">5</span>                  <span class="co"># Multiply a number to raster layers</span></span>
<span id="cb106-7"><a href="data-cubes-or-spatraster.html#cb106-7" tabindex="-1"></a>subset_mult <span class="ot">=</span> sub_ras_stack[[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]]<span class="sc">*</span><span class="dv">10</span>   <span class="co"># Multiply a number to a subset of raster layers</span></span>
<span id="cb106-8"><a href="data-cubes-or-spatraster.html#cb106-8" tabindex="-1"></a></span>
<span id="cb106-9"><a href="data-cubes-or-spatraster.html#cb106-9" tabindex="-1"></a><span class="co"># Data filtering based on cell-value</span></span>
<span id="cb106-10"><a href="data-cubes-or-spatraster.html#cb106-10" tabindex="-1"></a>filter_stack <span class="ot">=</span> sub_ras_stack            <span class="co"># Create a RasterBrick to operate on</span></span>
<span id="cb106-11"><a href="data-cubes-or-spatraster.html#cb106-11" tabindex="-1"></a>filter_stack[filter_stack<span class="sc">&lt;</span><span class="fl">0.5</span>] <span class="ot">=</span> <span class="cn">NA</span>     <span class="co"># Assign NA to any value less than 0.5</span></span>
<span id="cb106-12"><a href="data-cubes-or-spatraster.html#cb106-12" tabindex="-1"></a></span>
<span id="cb106-13"><a href="data-cubes-or-spatraster.html#cb106-13" tabindex="-1"></a><span class="co"># Let&#39;s plot the filtered rasters</span></span>
<span id="cb106-14"><a href="data-cubes-or-spatraster.html#cb106-14" tabindex="-1"></a><span class="fu">plot</span>(filter_stack, </span>
<span id="cb106-15"><a href="data-cubes-or-spatraster.html#cb106-15" tabindex="-1"></a>     <span class="at">col=</span>mypal2,  <span class="co"># Color pal  </span></span>
<span id="cb106-16"><a href="data-cubes-or-spatraster.html#cb106-16" tabindex="-1"></a>     <span class="at">asp=</span><span class="cn">NA</span>,      <span class="co"># Aspect ratio: NA, fill to plot space</span></span>
<span id="cb106-17"><a href="data-cubes-or-spatraster.html#cb106-17" tabindex="-1"></a>     <span class="at">nc=</span><span class="dv">2</span>,        <span class="co"># Number of columns to arrange plots</span></span>
<span id="cb106-18"><a href="data-cubes-or-spatraster.html#cb106-18" tabindex="-1"></a>    <span class="at">fun=</span><span class="cf">function</span>(){<span class="fu">plot</span>(<span class="fu">vect</span>(coastlines), <span class="at">add=</span><span class="cn">TRUE</span>)} <span class="co"># Add background map</span></span>
<span id="cb106-19"><a href="data-cubes-or-spatraster.html#cb106-19" tabindex="-1"></a>)                           </span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-25-1.png" width="672" /></p>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="data-cubes-or-spatraster.html#cb107-1" tabindex="-1"></a><span class="co"># Layer-wise Log-transformation</span></span>
<span id="cb107-2"><a href="data-cubes-or-spatraster.html#cb107-2" tabindex="-1"></a>log_ras_stack<span class="ot">=</span><span class="fu">log</span>(sub_ras_stack) </span>
<span id="cb107-3"><a href="data-cubes-or-spatraster.html#cb107-3" tabindex="-1"></a></span>
<span id="cb107-4"><a href="data-cubes-or-spatraster.html#cb107-4" tabindex="-1"></a><span class="co"># Normalize raster layers to [0,1] based on min and max of raster brick/stack</span></span>
<span id="cb107-5"><a href="data-cubes-or-spatraster.html#cb107-5" tabindex="-1"></a>norm_stk<span class="ot">=</span>(sub_ras_stack<span class="sc">-</span>min_val)<span class="sc">/</span>(max_val<span class="sc">-</span>min_val) <span class="co"># Notice that the values are between [0,1]</span></span>
<span id="cb107-6"><a href="data-cubes-or-spatraster.html#cb107-6" tabindex="-1"></a></span>
<span id="cb107-7"><a href="data-cubes-or-spatraster.html#cb107-7" tabindex="-1"></a><span class="co"># Plot in Robinson projection</span></span>
<span id="cb107-8"><a href="data-cubes-or-spatraster.html#cb107-8" tabindex="-1"></a>mypal3 <span class="ot">=</span> cetcolor<span class="sc">::</span><span class="fu">cet_pal</span>(<span class="dv">20</span>, <span class="at">name =</span> <span class="st">&quot;l5&quot;</span>)</span>
<span id="cb107-9"><a href="data-cubes-or-spatraster.html#cb107-9" tabindex="-1"></a>unikn<span class="sc">::</span><span class="fu">seecol</span>(mypal3)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-25-2.png" width="672" /></p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="data-cubes-or-spatraster.html#cb108-1" tabindex="-1"></a>WorldSHP <span class="ot">=</span> <span class="fu">st_as_sf</span>(spData<span class="sc">::</span>world)</span>
<span id="cb108-2"><a href="data-cubes-or-spatraster.html#cb108-2" tabindex="-1"></a></span>
<span id="cb108-3"><a href="data-cubes-or-spatraster.html#cb108-3" tabindex="-1"></a>norm_NDVI<span class="ot">=</span> <span class="fu">tm_shape</span>(WorldSHP, <span class="at">projection =</span> <span class="st">&#39;ESRI:54030&#39;</span>, </span>
<span id="cb108-4"><a href="data-cubes-or-spatraster.html#cb108-4" tabindex="-1"></a>                    <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">65</span>, <span class="dv">90</span>)<span class="sc">*</span><span class="dv">100000</span>, </span>
<span id="cb108-5"><a href="data-cubes-or-spatraster.html#cb108-5" tabindex="-1"></a>                    <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">152</span>,<span class="dv">152</span>)<span class="sc">*</span><span class="dv">100000</span>, </span>
<span id="cb108-6"><a href="data-cubes-or-spatraster.html#cb108-6" tabindex="-1"></a>                    <span class="at">raster.warp =</span> T)<span class="sc">+</span></span>
<span id="cb108-7"><a href="data-cubes-or-spatraster.html#cb108-7" tabindex="-1"></a>  <span class="fu">tm_sf</span>()<span class="sc">+</span></span>
<span id="cb108-8"><a href="data-cubes-or-spatraster.html#cb108-8" tabindex="-1"></a>  <span class="fu">tm_shape</span>(norm_stk[[<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>]], <span class="at">projection =</span> <span class="st">&#39;ESRI:54030&#39;</span>, <span class="at">raster.warp =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb108-9"><a href="data-cubes-or-spatraster.html#cb108-9" tabindex="-1"></a>  <span class="fu">tm_raster</span>(<span class="at">palette =</span> <span class="fu">rev</span>(mypal3), <span class="at">title =</span> <span class="st">&quot;Normalized NDVI&quot;</span>, <span class="at">style =</span> <span class="st">&quot;cont&quot;</span>)<span class="sc">+</span></span>
<span id="cb108-10"><a href="data-cubes-or-spatraster.html#cb108-10" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">main.title =</span> <span class="st">&quot;NDVI&quot;</span>,</span>
<span id="cb108-11"><a href="data-cubes-or-spatraster.html#cb108-11" tabindex="-1"></a>            <span class="at">main.title.fontfamily =</span> <span class="st">&quot;Times&quot;</span>,</span>
<span id="cb108-12"><a href="data-cubes-or-spatraster.html#cb108-12" tabindex="-1"></a>            <span class="at">legend.show =</span> T,</span>
<span id="cb108-13"><a href="data-cubes-or-spatraster.html#cb108-13" tabindex="-1"></a>            <span class="at">legend.outside =</span> T,</span>
<span id="cb108-14"><a href="data-cubes-or-spatraster.html#cb108-14" tabindex="-1"></a>            <span class="at">legend.outside.position =</span> <span class="fu">c</span>(<span class="st">&quot;right&quot;</span>, <span class="st">&quot;top&quot;</span>),</span>
<span id="cb108-15"><a href="data-cubes-or-spatraster.html#cb108-15" tabindex="-1"></a>            <span class="at">frame =</span> <span class="cn">FALSE</span>, </span>
<span id="cb108-16"><a href="data-cubes-or-spatraster.html#cb108-16" tabindex="-1"></a>            <span class="co">#earth.boundary = c(-160, -65, 160, 88),</span></span>
<span id="cb108-17"><a href="data-cubes-or-spatraster.html#cb108-17" tabindex="-1"></a>            <span class="at">earth.boundary.color =</span> <span class="st">&quot;grey&quot;</span>,</span>
<span id="cb108-18"><a href="data-cubes-or-spatraster.html#cb108-18" tabindex="-1"></a>            <span class="at">earth.boundary.lwd =</span> <span class="dv">2</span>,</span>
<span id="cb108-19"><a href="data-cubes-or-spatraster.html#cb108-19" tabindex="-1"></a>            <span class="at">fontfamily =</span> <span class="st">&quot;Times&quot;</span>)<span class="sc">+</span></span>
<span id="cb108-20"><a href="data-cubes-or-spatraster.html#cb108-20" tabindex="-1"></a>  <span class="fu">tm_graticules</span>(<span class="at">alpha =</span> <span class="fl">0.2</span>,                               <span class="co"># Add lat-long graticules</span></span>
<span id="cb108-21"><a href="data-cubes-or-spatraster.html#cb108-21" tabindex="-1"></a>                <span class="at">labels.inside.frame =</span> <span class="cn">FALSE</span>,  </span>
<span id="cb108-22"><a href="data-cubes-or-spatraster.html#cb108-22" tabindex="-1"></a>                <span class="at">col =</span> <span class="st">&quot;lightgrey&quot;</span>, <span class="at">n.x =</span> <span class="dv">4</span>, <span class="at">n.y =</span> <span class="dv">3</span>)<span class="sc">+</span></span>
<span id="cb108-23"><a href="data-cubes-or-spatraster.html#cb108-23" tabindex="-1"></a>  <span class="fu">tm_facets</span>(<span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb108-24"><a href="data-cubes-or-spatraster.html#cb108-24" tabindex="-1"></a></span>
<span id="cb108-25"><a href="data-cubes-or-spatraster.html#cb108-25" tabindex="-1"></a><span class="fu">print</span>(norm_NDVI)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-25-3.png" width="672" /></p>
</div>
<div id="cell-wise-operations-with-app-lapp-tapp" class="section level2 hasAnchor" number="5.4">
<h2><span class="header-section-number">5.4</span> Cell-wise operations with <code>app</code>, <code>lapp</code>, <code>tapp</code><a href="data-cubes-or-spatraster.html#cell-wise-operations-with-app-lapp-tapp" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We will now carry-out cell-wise operations on SpatRaster using the <code>app()</code>, <code>tapp()</code> and <code>lapp()</code> functions. These functions carry operations on <strong>each</strong> cell of a SpatRaster for <strong>all</strong> layers and are generally used to summarize the values of multiple layers into one layer. They are preferable in the presence of large raster datasets. Additionally, they allow you to save an output file directly.</p>
<center>
<img src="SampleData-master/images/cellwiseoperation2022.png" style="width:40.0%" />
</center>
<p><br></p>
<div id="app-cell-wise-operation-on-all-layers" class="section level3 hasAnchor" number="5.4.1">
<h3><span class="header-section-number">5.4.1</span> app: Cell-wise operation on all layers<a href="data-cubes-or-spatraster.html#app-cell-wise-operation-on-all-layers" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>app()</code> function applies a function to each cell of a raster and is used to summarize (e.g., calculating the sum) the values of multiple layers into one layer.</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="data-cubes-or-spatraster.html#cb109-1" tabindex="-1"></a><span class="co">#Let&#39;s look at the help section for app()</span></span>
<span id="cb109-2"><a href="data-cubes-or-spatraster.html#cb109-2" tabindex="-1"></a>?terra<span class="sc">::</span>app</span>
<span id="cb109-3"><a href="data-cubes-or-spatraster.html#cb109-3" tabindex="-1"></a></span>
<span id="cb109-4"><a href="data-cubes-or-spatraster.html#cb109-4" tabindex="-1"></a><span class="co"># Calculate mean of each grid cell across all layers</span></span>
<span id="cb109-5"><a href="data-cubes-or-spatraster.html#cb109-5" tabindex="-1"></a>mean_ras <span class="ot">=</span> <span class="fu">app</span>(sub_ras_stack, <span class="at">fun=</span>mean, <span class="at">na.rm =</span> T)</span>
<span id="cb109-6"><a href="data-cubes-or-spatraster.html#cb109-6" tabindex="-1"></a></span>
<span id="cb109-7"><a href="data-cubes-or-spatraster.html#cb109-7" tabindex="-1"></a><span class="co"># Calculate sum of each grid cell across all layers</span></span>
<span id="cb109-8"><a href="data-cubes-or-spatraster.html#cb109-8" tabindex="-1"></a>sum_ras <span class="ot">=</span> <span class="fu">app</span>(sub_ras_stack, <span class="at">fun=</span>sum, <span class="at">na.rm =</span> T)</span>
<span id="cb109-9"><a href="data-cubes-or-spatraster.html#cb109-9" tabindex="-1"></a></span>
<span id="cb109-10"><a href="data-cubes-or-spatraster.html#cb109-10" tabindex="-1"></a><span class="co">#~~ A user-defined function for mean, variance and skewness</span></span>
<span id="cb109-11"><a href="data-cubes-or-spatraster.html#cb109-11" tabindex="-1"></a>my_fun <span class="ot">=</span> <span class="cf">function</span>(x){ </span>
<span id="cb109-12"><a href="data-cubes-or-spatraster.html#cb109-12" tabindex="-1"></a>  meanVal<span class="ot">=</span><span class="fu">mean</span>(x, <span class="at">na.rm=</span><span class="cn">TRUE</span>)              <span class="co"># Mean </span></span>
<span id="cb109-13"><a href="data-cubes-or-spatraster.html#cb109-13" tabindex="-1"></a>  varVal<span class="ot">=</span><span class="fu">var</span>(x, <span class="at">na.rm=</span><span class="cn">TRUE</span>)                <span class="co"># Variance</span></span>
<span id="cb109-14"><a href="data-cubes-or-spatraster.html#cb109-14" tabindex="-1"></a>  skewVal<span class="ot">=</span>moments<span class="sc">::</span><span class="fu">skewness</span>(x, <span class="at">na.rm=</span><span class="cn">TRUE</span>) <span class="co"># Skewness</span></span>
<span id="cb109-15"><a href="data-cubes-or-spatraster.html#cb109-15" tabindex="-1"></a>  output<span class="ot">=</span><span class="fu">c</span>(meanVal,varVal,skewVal)         <span class="co"># Combine all statistics</span></span>
<span id="cb109-16"><a href="data-cubes-or-spatraster.html#cb109-16" tabindex="-1"></a>  <span class="fu">names</span>(output)<span class="ot">=</span><span class="fu">c</span>(<span class="st">&quot;Mean&quot;</span>, <span class="st">&quot;Var&quot;</span>,<span class="st">&quot;Skew&quot;</span>)    <span class="co"># Rename output variables</span></span>
<span id="cb109-17"><a href="data-cubes-or-spatraster.html#cb109-17" tabindex="-1"></a>  <span class="fu">return</span>(output)                           <span class="co"># Return output</span></span>
<span id="cb109-18"><a href="data-cubes-or-spatraster.html#cb109-18" tabindex="-1"></a>} </span>
<span id="cb109-19"><a href="data-cubes-or-spatraster.html#cb109-19" tabindex="-1"></a></span>
<span id="cb109-20"><a href="data-cubes-or-spatraster.html#cb109-20" tabindex="-1"></a><span class="co"># Apply user function to each cell across all layers</span></span>
<span id="cb109-21"><a href="data-cubes-or-spatraster.html#cb109-21" tabindex="-1"></a>stat_ras <span class="ot">=</span> <span class="fu">app</span>(sub_ras_stack, <span class="at">fun=</span>my_fun)</span>
<span id="cb109-22"><a href="data-cubes-or-spatraster.html#cb109-22" tabindex="-1"></a></span>
<span id="cb109-23"><a href="data-cubes-or-spatraster.html#cb109-23" tabindex="-1"></a><span class="co"># Plot statistics</span></span>
<span id="cb109-24"><a href="data-cubes-or-spatraster.html#cb109-24" tabindex="-1"></a><span class="fu">plot</span>(stat_ras, </span>
<span id="cb109-25"><a href="data-cubes-or-spatraster.html#cb109-25" tabindex="-1"></a>     <span class="at">col=</span>mypal2,  <span class="co"># Color pal  </span></span>
<span id="cb109-26"><a href="data-cubes-or-spatraster.html#cb109-26" tabindex="-1"></a>     <span class="at">asp=</span><span class="cn">NA</span>,      <span class="co"># Aspect ratio: NA, fill to plot space</span></span>
<span id="cb109-27"><a href="data-cubes-or-spatraster.html#cb109-27" tabindex="-1"></a>     <span class="at">nc=</span><span class="dv">2</span>,        <span class="co"># Number of columns to arrange plots</span></span>
<span id="cb109-28"><a href="data-cubes-or-spatraster.html#cb109-28" tabindex="-1"></a>     <span class="at">fun=</span><span class="cf">function</span>(){<span class="fu">plot</span>(<span class="fu">vect</span>(coastlines), <span class="at">add=</span><span class="cn">TRUE</span>)} <span class="co"># Add background map</span></span>
<span id="cb109-29"><a href="data-cubes-or-spatraster.html#cb109-29" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-26-1.png" width="672" />
DIY:Try plotting the same using <code>tmap</code>.</p>
</div>
<div id="tapp-cell-wise-operation-on-layer-groups" class="section level3 hasAnchor" number="5.4.2">
<h3><span class="header-section-number">5.4.2</span> tapp: Cell-wise operation on layer groups<a href="data-cubes-or-spatraster.html#tapp-cell-wise-operation-on-layer-groups" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>tapp()</code> is an extension of app(), allowing us to select a subset of layers for which we want to perform a certain operation. Let’s have the first two layers as group 1 and the next three as group 2. Function will be applied to each group separately and 2 layers of output will be generated.</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="data-cubes-or-spatraster.html#cb110-1" tabindex="-1"></a><span class="co">#Let&#39;s look at the help section for app()</span></span>
<span id="cb110-2"><a href="data-cubes-or-spatraster.html#cb110-2" tabindex="-1"></a>?terra<span class="sc">::</span>tapp</span>
<span id="cb110-3"><a href="data-cubes-or-spatraster.html#cb110-3" tabindex="-1"></a></span>
<span id="cb110-4"><a href="data-cubes-or-spatraster.html#cb110-4" tabindex="-1"></a><span class="co">#The layers are combined based on indexing.</span></span>
<span id="cb110-5"><a href="data-cubes-or-spatraster.html#cb110-5" tabindex="-1"></a>stat_ras <span class="ot">=</span> terra<span class="sc">::</span><span class="fu">tapp</span>(sub_ras_stack,</span>
<span id="cb110-6"><a href="data-cubes-or-spatraster.html#cb110-6" tabindex="-1"></a>                     <span class="at">index=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>),</span>
<span id="cb110-7"><a href="data-cubes-or-spatraster.html#cb110-7" tabindex="-1"></a>                     <span class="at">fun=</span> mean)</span>
<span id="cb110-8"><a href="data-cubes-or-spatraster.html#cb110-8" tabindex="-1"></a></span>
<span id="cb110-9"><a href="data-cubes-or-spatraster.html#cb110-9" tabindex="-1"></a><span class="co"># Try other functions: &quot;sum&quot;, &quot;mean&quot;, &quot;median&quot;, &quot;modal&quot;, &quot;which&quot;, &quot;which.min&quot;, &quot;which.max&quot;, &quot;min&quot;, &quot;max&quot;, &quot;prod&quot;, &quot;any&quot;, &quot;all&quot;, &quot;sd&quot;, &quot;first&quot;.</span></span>
<span id="cb110-10"><a href="data-cubes-or-spatraster.html#cb110-10" tabindex="-1"></a></span>
<span id="cb110-11"><a href="data-cubes-or-spatraster.html#cb110-11" tabindex="-1"></a><span class="fu">names</span>(stat_ras) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;Mean_of_rasters_1_to_2&quot;</span>, <span class="st">&quot;Mean_of_rasters_3_to_5&quot;</span>)</span>
<span id="cb110-12"><a href="data-cubes-or-spatraster.html#cb110-12" tabindex="-1"></a><span class="co"># Two layers are formed, one for each group of indices</span></span>
<span id="cb110-13"><a href="data-cubes-or-spatraster.html#cb110-13" tabindex="-1"></a></span>
<span id="cb110-14"><a href="data-cubes-or-spatraster.html#cb110-14" tabindex="-1"></a><span class="co"># Lets plot the two output rasters</span></span>
<span id="cb110-15"><a href="data-cubes-or-spatraster.html#cb110-15" tabindex="-1"></a><span class="fu">plot</span>(stat_ras, </span>
<span id="cb110-16"><a href="data-cubes-or-spatraster.html#cb110-16" tabindex="-1"></a>     <span class="at">col=</span>mypal2,  <span class="co"># Color pal  </span></span>
<span id="cb110-17"><a href="data-cubes-or-spatraster.html#cb110-17" tabindex="-1"></a>     <span class="at">asp=</span><span class="cn">NA</span>,      <span class="co"># Aspect ratio: NA, fill to plot space</span></span>
<span id="cb110-18"><a href="data-cubes-or-spatraster.html#cb110-18" tabindex="-1"></a>     <span class="at">nc=</span><span class="dv">2</span>,        <span class="co"># Number of columns to arrange plots</span></span>
<span id="cb110-19"><a href="data-cubes-or-spatraster.html#cb110-19" tabindex="-1"></a>     <span class="at">fun=</span><span class="cf">function</span>(){<span class="fu">plot</span>(<span class="fu">vect</span>(coastlines), <span class="at">add=</span><span class="cn">TRUE</span>)} <span class="co"># Add background map</span></span>
<span id="cb110-20"><a href="data-cubes-or-spatraster.html#cb110-20" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-27-1.png" width="672" />
DIY: Try plotting the same using <code>tidyterra</code>.</p>
</div>
<div id="lapp-layers-as-function-arguments" class="section level3 hasAnchor" number="5.4.3">
<h3><span class="header-section-number">5.4.3</span> lapp: layers as function arguments<a href="data-cubes-or-spatraster.html#lapp-layers-as-function-arguments" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>lapp()</code> function allows to apply a function to each cell using layers as arguments.</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="data-cubes-or-spatraster.html#cb111-1" tabindex="-1"></a><span class="co">#Let&#39;s look at the help section for app()</span></span>
<span id="cb111-2"><a href="data-cubes-or-spatraster.html#cb111-2" tabindex="-1"></a>?terra<span class="sc">::</span>lapp</span>
<span id="cb111-3"><a href="data-cubes-or-spatraster.html#cb111-3" tabindex="-1"></a></span>
<span id="cb111-4"><a href="data-cubes-or-spatraster.html#cb111-4" tabindex="-1"></a><span class="co">#User defined function for finding difference</span></span>
<span id="cb111-5"><a href="data-cubes-or-spatraster.html#cb111-5" tabindex="-1"></a>diff_fun <span class="ot">=</span> <span class="cf">function</span>(a, b){ <span class="fu">return</span>(a<span class="sc">-</span>b) }</span>
<span id="cb111-6"><a href="data-cubes-or-spatraster.html#cb111-6" tabindex="-1"></a></span>
<span id="cb111-7"><a href="data-cubes-or-spatraster.html#cb111-7" tabindex="-1"></a>diff_rast <span class="ot">=</span> <span class="fu">lapp</span>(sub_ras_stack[[<span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">2</span>)]], <span class="at">fun =</span> diff_fun)</span>
<span id="cb111-8"><a href="data-cubes-or-spatraster.html#cb111-8" tabindex="-1"></a></span>
<span id="cb111-9"><a href="data-cubes-or-spatraster.html#cb111-9" tabindex="-1"></a><span class="co">#Plot NDVI difference</span></span>
<span id="cb111-10"><a href="data-cubes-or-spatraster.html#cb111-10" tabindex="-1"></a><span class="fu">plot</span>(diff_rast, </span>
<span id="cb111-11"><a href="data-cubes-or-spatraster.html#cb111-11" tabindex="-1"></a>     <span class="at">col=</span>mypal2,  <span class="co"># Color pal  </span></span>
<span id="cb111-12"><a href="data-cubes-or-spatraster.html#cb111-12" tabindex="-1"></a>     <span class="at">asp=</span><span class="cn">NA</span>,      <span class="co"># Aspect ratio: NA, fill to plot space</span></span>
<span id="cb111-13"><a href="data-cubes-or-spatraster.html#cb111-13" tabindex="-1"></a>     <span class="at">nc=</span><span class="dv">2</span>,        <span class="co"># Number of columns to arrange plots</span></span>
<span id="cb111-14"><a href="data-cubes-or-spatraster.html#cb111-14" tabindex="-1"></a>     <span class="at">fun=</span><span class="cf">function</span>(){<span class="fu">plot</span>(<span class="fu">vect</span>(coastlines), <span class="at">add=</span><span class="cn">TRUE</span>)} <span class="co"># Add background map</span></span>
<span id="cb111-15"><a href="data-cubes-or-spatraster.html#cb111-15" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-28-1.png" width="672" /></p>
<hr />
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="geospatial-operations-on-rastervector-data.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="parallel-computation-for-geospatial-analysis.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/Vinit-Sehgal/lgar/edit/main/02-Largescale_Geospatial_Analysis_2025.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/Vinit-Sehgal/lgar/blob/main/02-Largescale_Geospatial_Analysis_2025.Rmd",
"text": null
},
"download": ["bookdownproj.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
